# async-warden

**async-warden** は、Node.js の Event Loop を監視し、  
過負荷状態に入る前に **予防的にサーバを守る** ための TypeScript 製 OSS です。

単なるレートリミッターや同時実行数制限ではなく、  
**Event Loop Lag と Event Loop Utilization（ELU）を組み合わせた判断**により、  
実運用で安定して動作する自動制御を目指しています。

---

## Why async-warden exists

Node.js サーバは高いスループットを持つ一方で、  
Event Loop が詰まると **一気にレスポンスが崩壊する** 特性があります。

多くのシステムでは次のような対策が取られがちです：

- 固定値の同時実行数制限
- CPU 使用率だけを見たスケーリング
- レスポンスタイム悪化後の事後的な遮断

しかしこれらは、

- 「遅くなってから」初めて制御が始まる  
- なぜリクエストが落とされたのか分からない  
- 負荷が戻った後も復帰が遅い  

といった問題を抱えています。

**async-warden はこれらを解決するために生まれました。**

---

## Core idea

### 1. Event Loop を“状態”として扱う

async-warden は以下の指標を中心に、Node.js の内部状態を観測します。

- **Event Loop Lag**  
  - 遅延の兆候・尾の伸び（p90 / p99）
- **Event Loop Utilization (ELU)**  
  - Event Loop がどれだけ忙しいか（原因側の指標）

どちらか一方に依存せず、  
**「遅くなっているか」＋「これから詰まりそうか」**  
を同時に評価します。

---

### 2. 予防的・連続的な制御

async-warden は単純な ON / OFF 制御を行いません。

- 閾値を超えたら遮断、ではない
- 状態に応じて **段階的・連続的に制御**
- 悪化時は素早く、回復時はゆっくり戻す

これにより、

- 過剰遮断を避ける
- フラッピング（行ったり来たり）を防ぐ
- 実運用で安定した挙動

を重視しています。

---

### 3. 計測・判断・防御の分離

async-warden は内部構造を明確に分離しています。

- **monitor**  
  Event Loop の状態を正確に計測する  
- **control**  
  計測結果から「どう制御すべきか」を判断する  
- **limiter**  
  判断結果に基づき、実際に処理を制御・遮断する  

この分離により、

- 理解しやすい設計
- チューニングしやすさ
- 将来的な拡張性

を確保しています。

---

### 4. 説明可能な shedding

負荷対策で最も困るのは、

> 「なぜこのリクエストが落とされたのか分からない」

という状態です。

async-warden は、

- なぜ制御が入ったのか
- どの指標が悪化していたのか
- どの判断によって落とされたのか

を **説明できる設計** を重視しています。

---

## Design goals

- Node.js 標準 API（`perf_hooks`）を中心に構成
- 外部依存は最小限
- TypeScript / ESM ファースト
- ロジックが「読めば理解できる」こと

async-warden は  
**ブラックボックスな守護神ではなく、理解できる番人**であることを目指します。

---

## Status

このプロジェクトは現在 **設計・実装フェーズ初期** にあります。

- API は安定していません
- 破壊的変更が入る可能性があります
- ただし、設計思想は一貫して保たれます

---
