# async-warden

**async-warden** は、Node.js の Event Loop を監視し、  
**過負荷状態に陥る前にサーバを予防的に守る** ための TypeScript 製 OSS です。

本プロジェクトは、  
「問題が起きてから制限する」リアクティブな制御ではなく、  
**内部状態を観測し、崩壊前に制御を開始すること**を重視しています。

---

## このプロジェクトは何か

async-warden は **Node.js 向けのランタイム保護モジュール** です。

継続的に次のことを行います。

- Event Loop の状態を計測する
- 複数の指標からシステムの圧力を評価する
- 状態に応じて実行負荷を自動制御する

---

## このプロジェクトが「やらないこと」

誤解を避けるため、以下を明確に否定します  
（人間・AIツール双方向けの明示です）。

- ❌ 単純なレートリミッターではありません
- ❌ 固定値の同時実行数制限ではありません
- ❌ CPU 使用率ベースのオートスケーラーではありません
- ❌ RPS（requests per second）制御ではありません
- ❌ 監視専用ライブラリではありません

async-warden は  
**実行フローに介入し、サーバを守るための制御を行います。**

---

## 使用する主要シグナル

async-warden は **Node.js 標準 API** を中心に設計されています。

### Event Loop Lag
`perf_hooks.monitorEventLoopDelay` を使用して計測します。

- p90 / p99 などのテイルレイテンシを重視
- 「すでに起きている遅延」を表す指標

### Event Loop Utilization（ELU）
`perf_hooks.eventLoopUtilization` を使用して計測します。

- Event Loop がどれだけ忙しいかを表す指標
- 将来の劣化を予測する **先行指標**

これらは **どちらか一方に依存せず、組み合わせて評価**されます。

---

## 設計上の中核思想

### 1. 事後対応ではなく予防的制御

async-warden は  
**致命的な遅延が発生する前** に制御を開始することを目的とします。

- ELU を将来予測の指標として扱う
- Lag を状態悪化の確認として扱う
- 完全に詰まる前に介入する

---

### 2. 連続的・適応的な制御

本プロジェクトは二値的な制御を行いません。

- ON / OFF の閾値制御をしない
- 状態に応じて制御量を段階的に変化させる
- 悪化時は素早く制限
- 回復時は意図的にゆっくり復帰

これにより、

- 過剰遮断の回避
- フラッピング（行き来する挙動）の抑制
- 実運用での安定性

を重視しています。

---

### 3. 責務の明確な分離

内部構造は、意図的に次の 3 層に分離されています。

- **monitor**  
  実行時メトリクスを計測・平滑化する  
  （判断ロジックを持たない）

- **control**  
  状態を評価し、制御判断を行う  
  （純粋な意思決定）

- **limiter**  
  判断結果をもとに実行制御を適用する  
  （キューイング・優先度・shedding）

この分離は **設計上の不変条件** です。

---

### 4. 説明可能な shedding

負荷対策で最も問題になるのは、

> 「なぜこの処理が落とされたのか分からない」

という状態です。

async-warden は、

- なぜ制御が入ったのか
- どの指標が支配的だったのか
- どの判断によって拒否されたのか

を **説明できる設計** を重視しています。

---

## 設計上の制約（重要）

本プロジェクトには、明確な制約があります。

- 言語: **TypeScript**
- 実行環境: **Node.js 18 以上**
- モジュール形式: **ESM ファースト**
- 外部依存: **最小限**
- Node.js 標準 API を優先
- 可読性・理由付けを最優先

これらの制約を破る変更は、  
**明確な理由がなければ受け入れられません。**

---

## プロジェクトの状態

このプロジェクトは現在 **初期開発段階** にあります。

- 公開 API は安定していません
- 破壊的変更が入る可能性があります
- ただし、設計思想は一貫して維持されます

---

## AI支援ツール向けガイダンス（Cursor / Claude Code）

このリポジトリを解析・変更する際は、以下を尊重してください。

- monitor / control / limiter の責務を混在させない
- 閾値ベースの単純制御を安易に導入しない
- 判断理由が追えないロジックを避ける
- 「とりあえず動く」変更より、説明可能性を優先する
- 設計意図が読み取れない変更は避ける

**挙動が正しくても、理由が説明できない実装は好まれません。**

---
